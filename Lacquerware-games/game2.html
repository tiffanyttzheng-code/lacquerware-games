<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¼†è‰ºåŒ å¿ƒ - æ¼†éª¨åˆæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: #121212;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Songti SC", "Noto Serif SC", serif; /* ä½¿ç”¨è¡¬çº¿ä½“æå‡é«˜çº§æ„Ÿ */
            color: white;
            overscroll-behavior: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            max-width: 375px;
            max-height: 812px;
            position: relative;
            overflow: hidden;
            background: #2c2c2c;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        @media (min-width: 400px) {
            #game-container {
                border-radius: 40px;
                border: 8px solid #333;
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* å°é¢é¡µæ ·å¼ */
        #cover-page {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, #5D4037, #3E2723); /* ä¿®æ”¹ï¼šæ·±æœ¨è‰²èƒŒæ™¯ */
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        .cover-title-group {
            display: flex;
            flex-direction: row-reverse; /* ç«–æ’æ–‡å­—ä»å³å‘å·¦è¯» */
            gap: 20px;
            margin-bottom: 60px;
        }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 0.5em;
        }

        .main-title {
            font-size: 48px;
            font-weight: 900;
            color: #d4a373;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* ä¿®æ”¹ï¼šå¢åŠ é˜´å½±å¯¹æ¯”åº¦ */
        }

        .sub-title {
            font-size: 16px;
            color: #d7ccc8; /* ä¿®æ”¹ï¼šæµ…æœ¨è‰²å‰¯æ ‡é¢˜ï¼Œå¢åŠ å¯¹æ¯”åº¦ */
            font-weight: 300;
            margin-top: 20px; 
        }

        .enter-btn {
            padding: 12px 40px;
            border: 1px solid #d4a373;
            color: #d4a373;
            font-size: 16px;
            letter-spacing: 4px;
            border-radius: 50px;
            background: rgba(0,0,0,0.2); /* ä¿®æ”¹ï¼šå¾®é€èƒŒæ™¯å¢åŠ å±‚æ¬¡ */
            transition: all 0.3s ease;
            animation: breathe 3s infinite ease-in-out;
            cursor: pointer;
        }

        .enter-btn:active {
            background: #d4a373;
            color: #000;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        .game-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: calc(20px + var(--safe-top)) 24px calc(40px + var(--safe-bottom)) 24px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* æ¸¸æˆå†…åˆ‡å›æ— è¡¬çº¿ */
        }

        .action-btn {
            pointer-events: auto;
            transition: transform 0.1s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .action-btn:active { transform: scale(0.92); }
        .action-btn.disabled { opacity: 0.3; filter: grayscale(1); }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 20px;
            pointer-events: auto;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-area {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .progress-container {
            flex-grow: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-right: 12px;
        }

        #progress-fill {
            width: 100%;
            height: 100%;
            background: #d4a373;
            transform: translateX(-100%);
            transition: transform 0.1s linear;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .stars-container {
            display: flex;
            gap: 2px;
        }

        .star-icon {
            font-size: 16px;
            transition: color 0.3s, text-shadow 0.3s;
        }
        .star-gold { color: #d4a373; text-shadow: 0 0 8px rgba(212,163,115,0.8); }
        .star-gray { color: #555; text-shadow: none; }

        #hit-zone-flash {
            position: absolute;
            bottom: 25%;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.4), transparent);
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: overlay; 
        }

        .overlay-mask {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4); 
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
        }

        .floating-card {
            background: #2a2a2a;
            width: 85%;
            padding: 24px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            max-width: 320px; 
        }

        .menu-btn {
            width: 100%;
            padding: 14px;
            margin: 6px 0;
            background: #3d3d3d;
            color: white;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
            position: relative;
        }
        .menu-btn:active { background: #555; }
        
        /* é”å®šå…³å¡æ ·å¼ */
        .menu-btn.locked {
            background: #222;
            color: #666;
            border: 1px solid #333;
            pointer-events: none;
        }
        .lock-icon {
            position: absolute;
            right: 15px;
            opacity: 0.5;
        }

        .pause-btn {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .pause-btn svg { width: 20px; height: 20px; fill: white; }

        .hint-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .result-image-box {
            width: 100%;
            height: 140px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .result-image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .star-result-active { color: #d4a373; text-shadow: 0 0 8px rgba(212,163,115,0.4); }

        #toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            padding: 12px 24px;
            border-radius: 50px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #puttyLevel {
            transition: height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .start-btn-pulse {
            background: #d4a373;
            color: black;
            padding: 16px 40px;
            border-radius: 30px;
            box-shadow: 0 0 20px rgba(212, 163, 115, 0.4);
            animation: pulse-scale 2s infinite;
        }
        @keyframes pulse-scale {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <!-- å°é¢é¡µ -->
    <div id="cover-page">
        <div class="cover-title-group">
            <div class="vertical-text main-title">æ¼†éª¨åˆæˆ</div>
            <div class="vertical-text sub-title">ä»¥æ¼†ä¸ºç¬” Â· è¡¥ç½…å®šåŸº</div>
        </div>
        <div class="enter-btn" onclick="enterGame()">å¼€å§‹åˆ®ç°</div>
    </div>

    <div class="game-ui" id="gameUI" style="display: none;">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="header-bar">
            <div id="pause-trigger" class="pause-btn">
                <svg id="pauseIcon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                <svg id="playIcon" viewBox="0 0 24 24" style="display:none;"><path d="M8 5v14l11-7z"/></svg>
            </div>

            <div class="header-info">
                <div id="staminaDisplay" class="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 backdrop-blur-sm">
                    <span id="staminaText" class="text-sm font-bold text-[#d4a373]">180/180</span>
                    <img src="images/power.png" class="w-4 h-4 object-contain">
                </div>
                <div id="stateLabel" class="bg-black/40 px-3 py-1.5 rounded-full text-[10px] font-bold tracking-widest border border-white/10 text-gray-300">
                    åˆ®ç²—ç°ï¼ˆæ…¢é€Ÿï¼‰
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€åŒºåŸŸ -->
        <div class="status-area">
            <div class="score-row">
                <div class="text-xs opacity-60" id="phaseText">å·¥è‰ºè¿›è¡Œä¸­</div>
                <div id="scoreDisplay" class="text-xl font-black text-[#d4a373] tracking-widest leading-none">å¾—åˆ†: 0</div>
            </div>
            <div class="progress-row">
                <div id="percentText" class="text-[10px] w-8 font-bold text-right mr-2 opacity-80">0%</div>
                <div class="progress-container">
                    <div id="progress-fill"></div>
                </div>
                <div class="stars-container" id="liveStars">
                    <span class="star-icon star-gray">â˜…</span>
                    <span class="star-icon star-gray">â˜…</span>
                    <span class="star-icon star-gray">â˜…</span>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å·¥å…·åŒº -->
        <div class="flex justify-between items-end pb-8 w-full mt-auto">
            <div id="bowlBtn" class="action-btn">
                <div class="w-28 h-28 bg-gray-200 rounded-full flex items-center justify-center shadow-xl relative overflow-hidden" style="border: 6px solid #444;">
                    <div id="puttyLevel" class="absolute bottom-0 left-0 right-0 bg-white opacity-95" style="height: 0%;"></div>
                    <span class="text-5xl z-10">ğŸ¥£</span>
                </div>
            </div>

            <div id="brushBtn" class="action-btn disabled">
                <div class="w-24 h-24 flex items-center justify-center relative bg-black/40 rounded-full border border-white/10 shadow-lg">
                    <span id="brushIcon" class="text-5xl transform -rotate-12">ğŸ–Œï¸</span>
                    <div id="brushStatus" class="absolute -top-1 -right-1 w-10 h-10 bg-white rounded-full border-[4px] border-[#1a1a1a] hidden flex items-center justify-center">
                         <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­å¤®æç¤ºæŒ‰é’® -->
    <div id="centralHint" class="hint-text w-full flex justify-center pointer-events-auto" style="display: none;">
        <div class="start-btn-pulse cursor-pointer" id="startAction">ç‚¹å‡»å¼€å§‹</div>
    </div>

    <!-- æš‚åœèœå• -->
    <div id="pause-menu" class="overlay-mask">
        <div class="floating-card">
            <h2 class="text-lg font-bold mb-6 tracking-widest text-[#d4a373]">åˆ¶ä½œæš‚åœ</h2>
            <div class="menu-btn" id="resumeBtn">ç»§ç»­åˆ¶ä½œ</div>
            <div class="menu-btn" id="showLevelsBtn">é€‰æ‹©å…³å¡</div>
            <div class="menu-btn mt-4" style="background: #5d4037;" onclick="resetToCover()">è¿”å›å°é¢</div>
        </div>
    </div>

    <!-- ç»“ç®—èœå• -->
    <div id="result-menu" class="overlay-mask">
        <!-- å†…å®¹åŠ¨æ€å¡«å…… -->
    </div>

    <!-- ä½“åŠ›æ¶ˆè€—ç¡®è®¤å¼¹çª— -->
    <div id="stamina-modal" class="overlay-mask">
        <div class="floating-card">
            <h2 class="text-xl font-bold mb-4 text-white">å¼€å¯ä¿®ä¸š</h2>
            <div class="text-sm text-gray-300 mb-8 flex items-center justify-center gap-1">
                æ˜¯å¦æ¶ˆè€— <span class="text-[#d4a373] font-bold text-lg">20</span>
                <img src="images/power.png" class="w-5 h-5 inline-block"> è¿›è¡Œæœ¬è½®åˆ®ç°ï¼Ÿ
            </div>
            <div class="flex gap-3 w-full">
                <div class="menu-btn bg-[#333] text-white border border-white/10" onclick="closeStaminaModal()">å–æ¶ˆ</div>
                <div class="menu-btn bg-[#d4a373] text-black font-black" onclick="confirmStartGame()">ç¡®è®¤</div>
            </div>
        </div>
    </div>

    <!-- å…³å¡åˆ—è¡¨èœå• -->
    <div id="level-menu" class="overlay-mask">
        <div class="floating-card">
            <h2 class="text-lg font-bold mb-4 tracking-widest text-[#d4a373]">é€‰æ‹©å·¥åº</h2>
            <div class="w-full flex flex-col items-center" id="levelList">
                <!-- åŠ¨æ€æ³¨å…¥ -->
            </div>
            <!-- æ³¨æ„ï¼šå¦‚æœæ˜¯ä»å°é¢è¿›å…¥çš„ï¼Œæ²¡æœ‰è¿”å›æŒ‰é’®ï¼Œæˆ–è€…è¿”å›åˆ°å°é¢ -->
            <div class="menu-btn mt-4 opacity-60 text-xs" id="backToPauseBtn" style="background:transparent; border:1px solid #444; display: none;">è¿”å›</div>
        </div>
    </div>

    <div id="hit-zone-flash"></div>

    <div id="toast">
        <span>è¯·å…ˆè˜¸å–è…»å­ï¼</span>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('game-container');
    const progressFill = document.getElementById('progress-fill');
    const percentText = document.getElementById('percentText');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const liveStars = document.getElementById('liveStars');
    const bowlBtn = document.getElementById('bowlBtn');
    const puttyLevelEl = document.getElementById('puttyLevel');
    const brushBtn = document.getElementById('brushBtn');
    const centralHint = document.getElementById('centralHint');
    const hitFlash = document.getElementById('hit-zone-flash');
    const pauseMenu = document.getElementById('pause-menu');
    const levelMenu = document.getElementById('level-menu');
    const resultMenu = document.getElementById('result-menu');
    const staminaModal = document.getElementById('stamina-modal');
    const pauseTrigger = document.getElementById('pause-trigger');
    const toast = document.getElementById('toast');
    const phaseText = document.getElementById('phaseText');
    const startAction = document.getElementById('startAction');
    const staminaText = document.getElementById('staminaText');
    const coverPage = document.getElementById('cover-page');
    const gameUI = document.getElementById('gameUI');
    const backToPauseBtn = document.getElementById('backToPauseBtn');
    
    // ä½“åŠ›ç³»ç»Ÿå˜é‡
    let currentStamina = 180;
    const maxStamina = 180;
    const gameCost = 20;

    // å…³å¡çŠ¶æ€è®°å½• (æ–°å¢ unlocked å±æ€§)
    let levelStats = {
        SLOW: { stars: 0, played: false, unlocked: true }, // ç¬¬ä¸€å…³é»˜è®¤è§£é”
        MED:  { stars: 0, played: false, unlocked: false },
        FAST: { stars: 0, played: false, unlocked: false }
    };

    let gameState = 'COVER'; // IDLE, SCRAPING, DRYING, SANDING, FINISHED, COVER
    let isPaused = false;
    let score = 0;
    let missedCount = 0;
    let totalChallengeTime = 90; 
    let timeLeft = 90;
    
    let puttyCharges = 0; 
    const MAX_CHARGES = 3;

    let dryingTimeTotal = 10; 
    let dryingTimeLeft = 10;
    let sandingTotalClicks = 10;
    let sandingCurrentClicks = 0;

    let frame = 0;
    let cracks = [];
    let particles = [];
    let woodY = 0;

    let currentLevel = 'SLOW';
    const config = {
        SLOW: { speed: 0.5, freq: 320, label: 'åˆ®ç²—ç°ï¼ˆæ…¢é€Ÿï¼‰' },
        MED:  { speed: 0.8, freq: 200, label: 'åˆ®ä¸­ç°ï¼ˆä¸­é€Ÿï¼‰' },
        FAST: { speed: 1.2, freq: 120, label: 'åˆ®ç»†ç°ï¼ˆå¿«é€Ÿï¼‰' }
    };

    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }
    window.onload = resize;
    window.addEventListener('resize', resize);

    // --- å°é¢ä¸æµç¨‹æ§åˆ¶ ---
    function enterGame() {
        coverPage.style.display = 'none';
        showLevelMenu(true); // true è¡¨ç¤ºä»å°é¢è¿›å…¥
    }

    function resetToCover() {
        location.reload(); // ç®€å•èµ·è§ï¼Œåˆ·æ–°é¡µé¢å›å°é¢
    }

    // --- ä½“åŠ›é€»è¾‘ ---
    function updateStaminaView() {
        staminaText.innerText = `${currentStamina}/${maxStamina}`;
    }

    function askToStartGame() {
        if (gameState !== 'IDLE' && gameState !== 'FINISHED') return;
        staminaModal.style.display = 'flex';
    }

    function closeStaminaModal() {
        staminaModal.style.display = 'none';
    }

    function confirmStartGame() {
        if (currentStamina >= gameCost) {
            currentStamina -= gameCost;
            updateStaminaView();
            closeStaminaModal();
            startGame();
        } else {
            closeStaminaModal();
            showToast("ä½“åŠ›ä¸è¶³ï¼Œæ— æ³•å¼€å§‹ï¼", true);
        }
    }

    function updateVisuals() {
        const heightPercent = puttyCharges === 0 ? 0 : (puttyCharges / MAX_CHARGES) * 85;
        puttyLevelEl.style.height = `${heightPercent}%`;

        if (puttyCharges > 0) {
            brushBtn.classList.remove('disabled');
        } else {
            brushBtn.classList.add('disabled');
        }
    }

    function updateStars() {
        const progress = 1 - (timeLeft / totalChallengeTime);
        let activeStars = 0;

        if (progress > 0.3 && missedCount <= 10) activeStars = 1;
        if (progress > 0.6 && missedCount <= 5) activeStars = 2;
        if (progress > 0.9 && missedCount === 0) activeStars = 3;

        if (missedCount > 10) activeStars = 0;
        else if (missedCount > 5 && activeStars > 1) activeStars = 1;
        else if (missedCount > 0 && activeStars > 2) activeStars = 2;

        const starElements = liveStars.children;
        for (let i = 0; i < 3; i++) {
            if (i < activeStars) {
                starElements[i].className = 'star-icon star-gold';
            } else {
                starElements[i].className = 'star-icon star-gray';
            }
        }
    }

    class Particle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.vx = (Math.random()-0.5)*12; 
            this.vy = (Math.random()-0.5)*12;
            this.life = 1.0;
            this.size = Math.random() * 4 + 2; 
            const colors = ["#ffffff", "#d4a373", "#fcd34d"];
            this.color = colors[Math.floor(Math.random() * colors.length)];
        }
        update() { 
            this.x += this.vx; 
            this.y += this.vy; 
            this.life -= 0.03; 
        }
        draw() {
            ctx.fillStyle = this.color; 
            ctx.globalAlpha = this.life;
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); 
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    class Crack {
        constructor() {
            this.y = -60;
            this.x = Math.random() * (canvas.width * 0.7) + (canvas.width * 0.15);
            this.width = 70 + Math.random() * 70;
            this.height = 14;
            this.repaired = false;
            this.missed = false;
        }
        draw() {
            ctx.save();
            if (this.repaired) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = "rgba(255, 215, 0, 0.8)"; 
                ctx.fillStyle = '#fff8e7'; 
                ctx.beginPath(); ctx.roundRect(this.x - this.width/2, this.y, this.width, this.height, 6); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath(); ctx.roundRect(this.x - this.width/2 + 2, this.y + 2, this.width - 4, this.height - 4, 4); ctx.fill();
            } else {
                ctx.strokeStyle = '#2d1b18'; ctx.lineWidth = 6;
                ctx.beginPath(); ctx.moveTo(this.x - this.width/2, this.y); ctx.lineTo(this.x + this.width/2, this.y + 4); ctx.stroke();
            }
            ctx.restore();
        }
    }

    function drawWoodBackground() {
        ctx.fillStyle = '#8d6e63'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        woodY += config[currentLevel].speed;
        ctx.strokeStyle = '#6d4c41'; ctx.lineWidth = 3.5;
        for (let i = -200; i < canvas.height + 200; i += 80) {
            ctx.beginPath();
            let y = i + (woodY % 80);
            ctx.moveTo(0, y); ctx.bezierCurveTo(canvas.width/2, y + 25, canvas.width/2, y - 25, canvas.width, y); ctx.stroke();
        }
        if (gameState === 'SCRAPING') {
            const hitZoneY = canvas.height * 0.75;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.06)';
            ctx.fillRect(0, hitZoneY - 45, canvas.width, 90);
            ctx.setLineDash([8, 6]);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
            ctx.beginPath(); ctx.moveTo(0, hitZoneY - 45); ctx.lineTo(canvas.width, hitZoneY - 45); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, hitZoneY + 45); ctx.lineTo(canvas.width, hitZoneY + 45); ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    function drawOverlays() {
        if (gameState === 'DRYING') {
            const progress = (dryingTimeTotal - dryingTimeLeft) / dryingTimeTotal; 
            const opacity = progress * 0.7;
            ctx.fillStyle = `rgba(200, 200, 200, ${opacity})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (Math.random() > 0.5) {
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.1})`;
                for(let i=0; i<50; i++) {
                    ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 2);
                }
            }
        } else if (gameState === 'SANDING') {
            const progress = (sandingTotalClicks - sandingCurrentClicks) / sandingTotalClicks;
            const opacity = progress * 0.7;
            ctx.fillStyle = `rgba(200, 200, 200, ${opacity})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    function loop() {
        if (!isPaused && gameState !== 'COVER') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;
            
            drawWoodBackground();

            if (gameState === 'SCRAPING') {
                if (frame % 60 === 0 && timeLeft > 0) {
                    timeLeft--;
                    const pct = Math.floor((1 - timeLeft / totalChallengeTime) * 100);
                    percentText.innerText = `${pct}%`;
                    progressFill.style.transform = `translateX(${- (timeLeft / totalChallengeTime) * 100}%)`;
                    updateStars(); 
                    if (timeLeft <= 0) startDrying();
                }
                if (frame % config[currentLevel].freq === 0) cracks.push(new Crack());
                
                const hitZoneBottom = (canvas.height * 0.75) + 45;

                cracks.forEach((c, idx) => {
                    c.y += config[currentLevel].speed; 
                    c.draw();
                    if (c.y > hitZoneBottom && !c.repaired && !c.missed) {
                        c.missed = true;
                        missedCount++;
                        updateStars();
                    }
                    if (c.y > canvas.height + 150) cracks.splice(idx, 1);
                });
            } else if (gameState === 'DRYING') {
                if (frame % 60 === 0 && dryingTimeLeft > 0) {
                    dryingTimeLeft--;
                    phaseText.innerText = `é™ç½®é˜´å¹²: ${dryingTimeLeft}s`;
                    const pct = Math.floor(((10 - dryingTimeLeft) / 10) * 100);
                    progressFill.style.transform = `translateX(${- (dryingTimeLeft / 10) * 100}%)`;
                    percentText.innerText = `${pct}%`;
                    if (dryingTimeLeft <= 0) startSanding();
                }
                cracks.forEach(c => c.draw());
            } else if (gameState === 'SANDING') {
                cracks.forEach(c => c.draw());
            }

            drawOverlays();

            particles.forEach((p, i) => {
                p.update(); p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            });
        }
        requestAnimationFrame(loop);
    }

    let toastTimer;
    function showToast(msg, isError = false) {
        toast.innerHTML = isError 
            ? `<span>âš ï¸ ${msg}</span>` 
            : `<span>${msg}</span>`;
        toast.style.opacity = '1';
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            toast.style.opacity = '0';
        }, 1500);
    }

    startAction.addEventListener('pointerdown', askToStartGame);

    bowlBtn.addEventListener('pointerdown', (e) => {
        e.stopPropagation();
        if (gameState !== 'SCRAPING' || isPaused) return;
        
        if (puttyCharges < MAX_CHARGES) {
            puttyCharges++;
            updateVisuals();
            bowlBtn.style.transform = "scale(1.1)";
            setTimeout(() => bowlBtn.style.transform = "scale(1)", 100);
        }
    });

    brushBtn.addEventListener('pointerdown', (e) => {
        e.stopPropagation();
        if (gameState !== 'SCRAPING' || isPaused) return;
        
        if (puttyCharges <= 0) {
            showToast("è¯·å…ˆè˜¸å–è…»å­ï¼");
            return;
        }

        puttyCharges--;
        updateVisuals();

        let hit = false;
        cracks.forEach(c => {
            if (Math.abs(c.y - canvas.height * 0.75) < 45 && !c.repaired) {
                c.repaired = true; hit = true; 
                score += 100;
                scoreDisplay.innerText = `å¾—åˆ†: ${score}`;
                for(let i=0; i<30; i++) particles.push(new Particle(c.x, c.y));
            }
        });
        if (hit) {
            hitFlash.style.animation = 'none'; hitFlash.offsetHeight;
            hitFlash.style.animation = 'flash 0.5s forwards';
        }
        hasPutty = false; brushBtn.classList.add('disabled'); brushStatus.classList.add('hidden');
    });

    container.addEventListener('pointerdown', (e) => {
        if (isPaused) return;
        if (e.target.closest('.action-btn') || e.target.closest('#pause-trigger')) return;

        if (gameState === 'SANDING') {
            sandingCurrentClicks++;
            const pct = Math.floor((sandingCurrentClicks / sandingTotalClicks) * 100);
            percentText.innerText = `${pct}%`;
            progressFill.style.transform = `translateX(${pct - 100}%)`;
            
            const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            for(let i=0; i<5; i++) particles.push(new Particle(x, y));

            if (sandingCurrentClicks >= sandingTotalClicks) {
                finishGame();
            }
        }
    });

    pauseTrigger.addEventListener('pointerdown', togglePause);
    document.getElementById('resumeBtn').addEventListener('pointerdown', togglePause);
    document.getElementById('showLevelsBtn').addEventListener('pointerdown', () => showLevelMenu(false));
    backToPauseBtn.addEventListener('pointerdown', () => {
        levelMenu.style.display = 'none'; pauseMenu.style.display = 'flex';
    });

    function togglePause() {
        if (gameState === 'IDLE' || gameState === 'FINISHED' || gameState === 'COVER') return;
        isPaused = !isPaused;
        pauseMenu.style.display = isPaused ? 'flex' : 'none';
        document.getElementById('pauseIcon').style.display = isPaused ? 'none' : 'block';
        document.getElementById('playIcon').style.display = isPaused ? 'block' : 'none';
    }

    function resetToIdle() {
        gameState = 'IDLE';
        isPaused = false;
        
        pauseMenu.style.display = 'none';
        levelMenu.style.display = 'none';
        resultMenu.style.display = 'none';
        staminaModal.style.display = 'none';
        
        gameUI.style.display = 'flex'; // ç¡®ä¿UIæ˜¾ç¤º
        centralHint.style.display = 'flex'; // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®å®¹å™¨
        centralHint.classList.remove('hidden');
        centralHint.innerHTML = '<div class="start-btn-pulse cursor-pointer" id="startAction">ç‚¹å‡»å¼€å§‹</div>';
        
        document.getElementById('startAction').addEventListener('pointerdown', askToStartGame);
        
        score = 0;
        scoreDisplay.innerText = 'å¾—åˆ†: 0';
        percentText.innerText = '0%';
        phaseText.innerText = 'å·¥è‰ºè¿›è¡Œä¸­';
        progressFill.style.transform = 'translateX(-100%)';
        
        const starElements = liveStars.children;
        for(let el of starElements) el.className = 'star-icon star-gray';
        
        cracks = [];
        particles = [];
        puttyCharges = 0;
        updateVisuals();
        
        bowlBtn.style.display = 'flex';
        brushBtn.style.display = 'flex';
    }

    function startGame() {
        gameState = 'SCRAPING';
        centralHint.classList.add('hidden');
        resultMenu.style.display = 'none'; 
        timeLeft = totalChallengeTime;
        missedCount = 0; score = 0; cracks = [];
        scoreDisplay.innerText = `å¾—åˆ†: 0`;
        percentText.innerText = "0%";
        phaseText.innerText = "å·¥è‰ºè¿›è¡Œä¸­";
        puttyCharges = 0; 
        updateVisuals();
        updateStars(); 
        progressFill.style.transform = `translateX(-100%)`;
        
        bowlBtn.style.display = 'flex';
        brushBtn.style.display = 'flex';
    }

    function startDrying() {
        gameState = 'DRYING';
        dryingTimeLeft = 10;
        phaseText.innerText = "é™ç½®é˜´å¹²: 10s";
        percentText.innerText = "0%";
        progressFill.style.transform = `translateX(-100%)`;
        centralHint.innerHTML = '<div class="text-xl font-bold tracking-widest text-white/80">é™ç½®é˜´å¹²ä¸­...</div>';
        centralHint.classList.remove('hidden');
        bowlBtn.style.display = 'none';
        brushBtn.style.display = 'none';
    }

    function startSanding() {
        gameState = 'SANDING';
        sandingCurrentClicks = 0;
        phaseText.innerText = "ç‚¹å‡»å±å¹•æ‰“ç£¨";
        percentText.innerText = "0%";
        progressFill.style.transform = `translateX(-100%)`;
        centralHint.innerHTML = '<div class="text-xl font-bold tracking-widest text-white/80">ç‚¹å‡»å±å¹•æ‰“ç£¨</div>';
        centralHint.classList.remove('hidden');
    }

    function finishGame() {
        gameState = 'FINISHED';
        centralHint.classList.add('hidden');
        
        let stars = 3;
        if (missedCount > 10) stars = 0;
        else if (missedCount > 5) stars = 1;
        else if (missedCount > 0) stars = 2;

        let statusText = stars === 3 ? "åœ†æ»¡å®Œæˆ" : (stars === 2 ? "ä»»åŠ¡å®Œæˆ" : (stars === 1 ? "æ™®é€šå®Œæˆ" : "ä»»åŠ¡å¤±è´¥"));
        
        let imgSrc = "";
        if (stars === 3) imgSrc = "images/emo-satisfied.png";
        else if (stars === 2) imgSrc = "images/emo-good.png";
        else imgSrc = "images/emo-angry.png";

        // æ›´æ–°è®°å½•
        levelStats[currentLevel].played = true;
        levelStats[currentLevel].stars = Math.max(levelStats[currentLevel].stars, stars);

        // å…³å¡è§£é”é€»è¾‘: å¦‚æœå½“å‰å…³å¡è‡³å°‘1æ˜Ÿï¼Œè§£é”ä¸‹ä¸€å…³
        if (stars >= 1) {
            if (currentLevel === 'SLOW') levelStats['MED'].unlocked = true;
            else if (currentLevel === 'MED') levelStats['FAST'].unlocked = true;
        }

        let starHtml = "";
        for(let i=0; i<3; i++) starHtml += `<span class="${i < stars ? 'star-result-active' : 'opacity-20'} text-2xl mx-1">â˜…</span>`;

        resultMenu.innerHTML = `
            <div class="floating-card pointer-events-auto">
                <div class="text-xs opacity-50 mb-2 tracking-widest">å®Œæˆæƒ…å†µ</div>
                
                <div class="text-xl font-bold tracking-widest mb-1 text-white">${statusText}</div>
                <div class="text-sm opacity-70 mb-1">å¾—åˆ†: ${score}</div>
                <div class="mb-2">${starHtml}</div>
                
                <div class="result-image-box">
                    <img src="${imgSrc}" alt="${statusText}">
                </div>
                
                <div class="menu-btn bg-[#d4a373] text-black font-black" onclick="askToRetry()">å†æ¥ä¸€æ¬¡</div>
                <div class="menu-btn bg-transparent border border-[#555] text-xs mt-0" onclick="showLevelMenuFromFinish()">é€‰æ‹©å…³å¡</div>
            </div>
        `;
        resultMenu.style.display = 'flex';
    }

    window.askToRetry = function() {
        resultMenu.style.display = 'none';
        askToStartGame();
    };

    function showLevelMenu(fromCover = false) {
        pauseMenu.style.display = 'none';
        renderLevels();
        levelMenu.style.display = 'flex';
        // å¦‚æœæ˜¯ä»å°é¢è¿›å…¥ï¼Œéšè—â€œè¿”å›â€æŒ‰é’®ï¼ˆæˆ–è€…æ‚¨å¯ä»¥é€‰æ‹©è®©å®ƒè¿”å›å°é¢ï¼‰
        backToPauseBtn.style.display = fromCover ? 'none' : 'block';
    }

    function showLevelMenuFromFinish() {
        resultMenu.style.display = 'none';
        renderLevels();
        levelMenu.style.display = 'flex';
        backToPauseBtn.style.display = 'none'; // ç»“ç®—é¡µè¿›å…¥æ— æ³•è¿”å›æš‚åœé¡µ
    }

    function renderLevels() {
        const list = document.getElementById('levelList');
        list.innerHTML = "";
        Object.keys(config).forEach(key => {
            const stat = levelStats[key];
            let stars = "";
            if(stat.played) {
                for(let i=0; i<3; i++) stars += i < stat.stars ? "â˜…" : "â˜†";
            }
            
            const btn = document.createElement('div');
            if (!stat.unlocked) {
                // é”å®šçŠ¶æ€
                btn.className = "menu-btn flex justify-between items-center locked";
                btn.innerHTML = `<span>${config[key].label}</span><span class="text-xs">ğŸ”’</span>`;
            } else {
                // è§£é”çŠ¶æ€
                btn.className = "menu-btn flex justify-between items-center";
                btn.innerHTML = `<span>${config[key].label}</span><span class="text-[#d4a373] text-xs">${stars}</span>`;
                btn.onclick = () => {
                    currentLevel = key;
                    document.getElementById('stateLabel').innerText = config[key].label;
                    levelMenu.style.display = 'none';
                    resetToIdle(); 
                };
            }
            list.appendChild(btn);
        });
    }

    // æš´éœ²åˆ° window
    window.enterGame = enterGame;
    window.resetToCover = resetToCover;
    window.closeStaminaModal = closeStaminaModal;
    window.confirmStartGame = confirmStartGame;
    window.showLevelMenuFromFinish = showLevelMenuFromFinish;
    window.resetToIdle = resetToIdle;

    loop();
</script>

</body>
</html>