<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day 1: æ—‹æœ¨æˆèƒ</title>
    <style>
        /* === åŸºç¡€è®¾å®š (æµ…è‰²æœ¨è´¨ä¸»é¢˜) === */
        :root {
            --bg-color: #e6dcc3;       /* æµ…å¡å…¶åº•è‰² */
            --wood-dark: #5d4037;      /* æ·±æœ¨çº¹è‰² */
            --text-main: #3e2723;      /* æ·±æ —è‰²æ–‡å­— */
            --gold-accent: #a67c00;    /* å¤é“œé‡‘ (UIä¸»è‰²) */
            --star-yellow: #ffc107;    /* æ˜Ÿæ˜Ÿé»„è‰² */
            --cinnabar: #c62828;       /* æœ±çº¢ */
            --overlay-bg: rgba(235, 225, 210, 0.95); /* æµ…è‰²é®ç½© */
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a; /* ç½‘é¡µèƒŒæ™¯ä¿æŒæ·±è‰²ä»¥è¡¬æ‰˜æ‰‹æœº */
            font-family: 'Songti SC', 'Noto Serif SC', 'SimSun', serif; 
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* ğŸ“± æ‰‹æœºå®¹å™¨ */
        #phone-container {
            position: relative;
            background-color: var(--bg-color);
            /* æœ¨è´¨çº¹ç†ç”Ÿæˆ */
            background-image: 
                repeating-linear-gradient(45deg, rgba(93, 64, 55, 0.03) 0px, rgba(93, 64, 55, 0.03) 1px, transparent 1px, transparent 12px),
                linear-gradient(to bottom, #e6dcc3, #d7cbb0);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            height: 90vh;
            width: calc(90vh * (375 / 812));
            border: 8px solid #2d241f; /* è¾¹æ¡†æ”¹ä¸ºæ·±èƒ¡æ¡ƒæœ¨è‰² */
            border-radius: 40px;
        }

        @media (max-width: 500px) {
            #phone-container {
                width: 100vw;
                height: 100vh;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* === é¡¶éƒ¨åŒºåŸŸé‡æ„ (æš‚åœæŒ‰é’® + ä½“åŠ›æ¡) === */
        #stamina-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px; /* é«˜åº¦å¢åŠ  */
            /* æµ…è‰²æ¸å˜é¡¶æ  */
            background: linear-gradient(to bottom, rgba(230, 220, 195, 1) 40%, rgba(230, 220, 195, 0));
            z-index: 20;
            display: flex;
            align-items: center;
            /* å·¦ä¾§ç•™å‡ºç©ºé—´ç»™æš‚åœæŒ‰é’®ï¼Œé˜²æ­¢é‡å  */
            padding: 0 24px 0 80px; 
            box-sizing: border-box;
        }

        /* æš‚åœæŒ‰é’® - ç§»è‡³å·¦ä¸Šè§’ï¼Œæ•´åˆè¿›é¡¶éƒ¨æ  */
        #custom-pause-btn {
            position: absolute;
            top: 15px; /* å‚ç›´å±…ä¸­äºé¡¶éƒ¨æ  */
            left: 20px;
            width: 44px; /* æŒ‰é’®åŠ å¤§ */
            height: 44px;
            border: 3px solid rgba(62, 39, 35, 0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
            z-index: 25; /* å±‚çº§é«˜äºä½“åŠ›æ¡èƒŒæ™¯ */
            background: rgba(255,255,255,0.4);
            font-size: 14px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
        }
        #custom-pause-btn:active {
            border-color: var(--text-main);
            background: rgba(62, 39, 35, 0.1);
            transform: scale(0.95);
        }

        #stamina-icon-img {
            width: 24px; /* å›¾æ ‡åŠ å¤§ */
            height: 24px;
            margin-right: 12px;
            opacity: 1;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        #stamina-bar-bg {
            flex: 1;
            height: 10px; /* æ§½åŠ ç²— */
            background: rgba(62, 39, 35, 0.15);
            border-radius: 5px;
            overflow: hidden;
            margin-right: 15px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        #stamina-bar-fill {
            height: 100%;
            background: var(--gold-accent);
            width: 66%;
            transition: width 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        #stamina-text {
            font-size: 18px; /* å­—ä½“åŠ å¤§ */
            color: var(--text-main);
            font-weight: 900;
            font-family: 'Helvetica Neue', sans-serif;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
        }

        /* === æ¸¸æˆå†… HUD (æ•°æ®æ ) - ä¸‹ç§»é¿å…å¹²æ‰° === */
        #game-hud {
            position: absolute;
            top: 85px; /* å½»åº•ç§»å‡ºé¡¶éƒ¨æ åŒºåŸŸ */
            width: 100%;
            display: flex;
            justify-content: space-around; /* åˆ†æ•£å¯¹é½ï¼Œè§†è§‰æ›´å¹³è¡¡ */
            padding: 0 10px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 10;
        }

        .hud-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.3); /* è½»å¾®èƒŒæ™¯å¢å¼ºå¯è¯»æ€§ */
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid rgba(62, 39, 35, 0.05);
        }

        .hud-label {
            font-size: 14px; /* åŠ å¤§ */
            color: rgba(62, 39, 35, 0.7);
            margin-bottom: 2px;
            letter-spacing: 2px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .hud-value {
            font-size: 32px; /* æ˜¾è‘—åŠ å¤§ */
            color: var(--text-main);
            font-weight: 900;
            text-shadow: 0 2px 0 rgba(255,255,255,0.6);
            line-height: 1;
            margin-top: 5px;
        }

        /* === é®ç½©å±‚ === */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            color: var(--text-main);
            text-align: center;
            transition: opacity 0.3s ease;
        }

        .overlay h1 {
            font-size: 48px; /* åŠ å¤§ */
            font-weight: 900;
            margin-bottom: 15px;
            letter-spacing: 12px;
            color: var(--text-main);
            text-shadow: 2px 2px 0 rgba(255,255,255,0.6);
            border-bottom: 4px solid var(--text-main);
            padding-bottom: 25px;
            margin-top: 0;
        }

        .overlay p {
            font-size: 16px; /* åŠ å¤§ */
            color: rgba(62, 39, 35, 0.8);
            margin-bottom: 60px;
            letter-spacing: 4px;
            font-weight: 700;
        }

        /* === æŒ‰é’®è®¾è®¡ === */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px; /* é—´è·è°ƒå° (åŸ20px) */
            width: 70%; /* å®½åº¦ç¨å¾®è°ƒå¤§ä»¥é€‚åº”å°æŒ‰é’® */
        }

        button {
            padding: 12px 0; /* é«˜åº¦è°ƒå° (åŸ16px) */
            background: transparent;
            color: var(--text-main);
            border: 3px solid var(--text-main); /* è¾¹æ¡†åŠ ç²— */
            border-radius: 6px;
            font-size: 18px; /* å­—å·è°ƒå° (åŸ20px) */
            font-weight: 900;
            letter-spacing: 4px; /* å­—é—´è·è°ƒå° (åŸ6px) */
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-family: inherit;
            box-shadow: 0 4px 0 rgba(62, 39, 35, 0.15);
        }

        button:active {
            transform: translateY(3px);
            box-shadow: none;
            background: rgba(62, 39, 35, 0.05);
        }

        button.primary {
            background: var(--text-main);
            color: #e6dcc3;
            border-color: var(--text-main);
        }
        
        button.primary:active {
            background: #2c1e15;
        }

        /* === ç»“ç®—ç•Œé¢ (æ”¾å¤§ç‰ˆ) === */
        #result-title {
            font-size: 64px; /* å·¨å‹æ ‡é¢˜ */
            margin-bottom: 5px; /* å‡å°‘é—´è· */
            letter-spacing: 10px;
            text-shadow: 3px 3px 0 rgba(255,255,255,0.5);
        }

        #result-img {
            width: 280px; /* è¶…å¤§å›¾ç‰‡ */
            height: 280px;
            margin-bottom: -20px; /* å‘ä¸Šæ”¶ç´§é—´è· */
            border: none;
            padding: 0;
            object-fit: contain;
            background: transparent;
            border-radius: 0;
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.25)); /* æŠ•å½±åŠ å¼º */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        #star-rating {
            font-size: 48px; /* æ˜Ÿæ˜Ÿæå¤§ */
            color: var(--star-yellow); 
            margin-bottom: 0px; /* é—´è·è¿›ä¸€æ­¥è°ƒå° (åŸ5px) */
            letter-spacing: 15px;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #result-desc {
            font-weight: 800;
            font-size: 24px; /* æè¿°æ–‡å­—åŠ å¤§ */
            color: var(--text-main);
            line-height: 1.5;
            margin-bottom: 15px; /* é—´è·è°ƒå° (åŸ20px) */
            letter-spacing: 2px;
        }

        /* === ç¡®è®¤å¼¹çª— === */
        #confirm-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(62, 39, 35, 0.4);
            backdrop-filter: blur(4px);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fdfbf7;
            border: 3px solid var(--text-main);
            padding: 40px;
            text-align: center;
            width: 80%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            border-radius: 12px;
        }
        .modal-content h3 {
            font-weight: 900;
            color: var(--text-main);
            margin: 0 0 15px 0;
            letter-spacing: 4px;
            font-size: 28px; /* åŠ å¤§ */
        }
        .modal-content p {
            color: rgba(62, 39, 35, 0.9);
            font-weight: 700;
            margin: 0 0 35px 0;
            font-size: 16px;
        }
        .modal-btn-row {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .modal-btn-row button {
            padding: 12px 30px;
            font-size: 16px;
            border-width: 2px;
            width: auto;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="phone-container">
        
        <!-- é¡¶éƒ¨é€šæ : åŒ…å«æš‚åœæŒ‰é’®å’Œä½“åŠ›æ¡ -->
        <div id="stamina-container">
            <!-- æš‚åœæŒ‰é’®ç§»åˆ°è¿™é‡Œï¼Œç»å¯¹å®šä½åœ¨å·¦ä¾§ -->
            <button id="custom-pause-btn" onclick="togglePause()">||</button>
            
            <img id="stamina-icon-img" src="images/power.png" alt="Power">
            <div id="stamina-bar-bg">
                <div id="stamina-bar-fill"></div>
            </div>
            <div id="stamina-text">120/180</div>
        </div>

        <!-- æ¸¸æˆ HUD (ä¸‹ç§») -->
        <div id="game-hud" class="hidden">
            <div class="hud-item">
                <div class="hud-label">ä¿®æ•´è¿›åº¦</div>
                <div class="hud-value" id="hud-progress">0/10</div>
            </div>
            <div class="hud-item">
                <div class="hud-label">èƒä½“æŸä¼¤</div>
                <div class="hud-value" id="hud-mistakes" style="color:var(--cinnabar)">0</div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="overlay">
            <h1>æ—‹æœ¨æˆèƒ</h1>
            <p>Day 1 Â· åˆ¶èƒå·¥è‰º<br><span style="color:rgba(62,39,35,0.5); font-weight:700; font-size:14px; margin-top:10px; display:inline-block;">æ¶ˆè€— 20 ä½“åŠ› / æ¬¡</span></p>
            <div class="btn-group">
                <button onclick="tryStartLevel(0)">ç¬¬ä¸€ç«  Â· åˆè¯•</button>
                <button onclick="tryStartLevel(1)">ç¬¬äºŒç«  Â· ç²¾ä¿®</button>
                <button onclick="tryStartLevel(2)" class="primary">ç¬¬ä¸‰ç«  Â· å…¥ç¥</button>
            </div>
        </div>

        <!-- Pause Menu -->
        <div id="pause-menu" class="overlay hidden">
            <h1>æš‚åœ</h1>
            <div class="btn-group">
                <button class="primary" onclick="togglePause()">ç»§ç»­æ—‹å‰Š</button>
                <button onclick="tryStartLevel(currentLevelIndex)">é‡æ–°å¼€å§‹</button>
                <button onclick="showStartScreen()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="overlay hidden">
            <h1 id="result-title">å®Œæˆ</h1>
            
            <img id="result-img" src="" alt="è¯„ä»·">
            
            <div id="star-rating"></div>
            
            <p id="result-desc">ç»“ç®—ä¸­...</p>
            
            <div class="btn-group">
                <!-- æ–°å¢ï¼šè¿›å…¥ä¸‹ä¸€ç« ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <button id="result-next-btn" class="primary hidden">è¿›å…¥ä¸‹ä¸€ç« </button>
                <!-- å§‹ç»ˆå­˜åœ¨ï¼šå†æ¥ä¸€æ¬¡ -->
                <button id="result-retry-btn" onclick="tryStartLevel(currentLevelIndex)">å†æ¥ä¸€æ¬¡</button>
                <button id="result-main-btn" onclick="showStartScreen()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirm-modal" class="hidden">
            <div class="modal-content">
                <h3>ç¡®è®¤å¼€å¯</h3>
                <p>å°†æ¶ˆè€— 20 ä½“åŠ›</p>
                <div class="modal-btn-row">
                    <button onclick="closeConfirm()">å–æ¶ˆ</button>
                    <button class="primary" onclick="confirmStart()">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const hudLayer = document.getElementById('game-hud');
        const hudProgress = document.getElementById('hud-progress');
        const hudMistakes = document.getElementById('hud-mistakes');
        
        const staminaFill = document.getElementById('stamina-bar-fill');
        const staminaText = document.getElementById('stamina-text');
        
        const startScreen = document.getElementById('start-screen');
        const pauseMenu = document.getElementById('pause-menu');
        const resultScreen = document.getElementById('result-screen');
        const confirmModal = document.getElementById('confirm-modal');
        
        const resultTitle = document.getElementById('result-title');
        const resultImg = document.getElementById('result-img');
        const starRating = document.getElementById('star-rating');
        const resultDesc = document.getElementById('result-desc');
        const resultMainBtn = document.getElementById('result-main-btn');
        const resultNextBtn = document.getElementById('result-next-btn');
        const resultRetryBtn = document.getElementById('result-retry-btn');

        // ==========================================
        // âš™ï¸ å…¨å±€é…ç½®ä¸çŠ¶æ€
        // ==========================================
        
        let stamina = 120;
        const maxStamina = 180;
        const costPerLevel = 20;

        const levels = [
            {
                name: "ç¬¬ä¸€ç« ",
                baseSpeed: 0.013,
                variableSpeed: false, 
                wasteCount: 5,        
                wasteGap: 0.1         
            },
            {
                name: "ç¬¬äºŒç« ",
                baseSpeed: 0.018,
                variableSpeed: false,
                wasteCount: 8,       
                wasteGap: 0.12
            },
            {
                name: "ç¬¬ä¸‰ç« ",
                baseSpeed: 0.012,
                variableSpeed: true,  
                wasteCount: 11,
                wasteGap: 0.1
            }
        ];

        const LOGICAL_WIDTH = 375;
        const LOGICAL_HEIGHT = 812;
        // èƒŒæ™¯è‰²å˜é‡ï¼Œéœ€è¦ä¸ CSS é…åˆï¼Œè¿™é‡Œè®¾ä¸ºé€æ˜ï¼Œè®© Canvas ä¸‹æ–¹çš„ CSS æœ¨çº¹æ˜¾ç¤ºå‡ºæ¥
        const BG_COLOR = 'rgba(230, 220, 195, 0)'; 

        let gameState = 'start'; 
        let currentLevelIndex = 0;
        let pendingLevelIndex = 0;
        
        let rotationAngle = 0; 
        let currentSpeed = 0;
        let time = 0; 
        
        let particles = []; 
        let wasteSegments = [];
        
        let mistakes = 0;
        const maxMistakes = 3; 
        let eliminatedCount = 0;
        let totalWasteCount = 0;

        let centerX, centerY;
        let woodRadius = 100; 
        let wasteHeight = 40; 
        let shakeOffset = {x:0, y:0};

        function initDimensions() {
            canvas.width = LOGICAL_WIDTH;
            canvas.height = LOGICAL_HEIGHT;
            centerX = LOGICAL_WIDTH / 2;
            // â¬‡ï¸ ä¿®æ”¹ï¼šé‡å¿ƒä¸‹ç§»ï¼Œä¸ºé¡¶éƒ¨å˜å¤§çš„UIç•™å‡ºç©ºé—´ (åŸ +50 -> +60)
            centerY = LOGICAL_HEIGHT / 2 + 60; 
            updateStaminaUI();
        }

        // ================= ä½“åŠ›ä¸æµç¨‹æ§åˆ¶ =================

        function updateStaminaUI() {
            let pct = (stamina / maxStamina) * 100;
            staminaFill.style.width = pct + "%";
            staminaText.innerText = `${stamina}/${maxStamina}`;
            
            if(stamina < 20) {
                staminaFill.style.background = "#c62828"; 
            } else {
                staminaFill.style.background = "#a67c00"; 
            }
        }

        function tryStartLevel(index) {
            if (stamina < costPerLevel) {
                alert("ä½“åŠ›ä¸è¶³ã€‚");
                return;
            }
            pendingLevelIndex = index;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirm() {
            confirmModal.classList.add('hidden');
        }

        function confirmStart() {
            closeConfirm();
            stamina -= costPerLevel;
            updateStaminaUI();
            currentLevelIndex = pendingLevelIndex;
            startGame();
        }

        function startGame() {
            let config = levels[currentLevelIndex];
            gameState = 'playing';
            
            startScreen.classList.add('hidden');
            pauseMenu.classList.add('hidden');
            resultScreen.classList.add('hidden');
            hudLayer.classList.remove('hidden');
            
            rotationAngle = 0;
            time = 0;
            currentSpeed = config.baseSpeed;
            particles = [];
            wasteSegments = [];
            mistakes = 0;
            eliminatedCount = 0;
            totalWasteCount = config.wasteCount; 
            
            updateHUD();
            generateWaste(config);
            loop(); 
        }

        function updateHUD() {
            hudProgress.innerText = `${eliminatedCount} / ${totalWasteCount}`;
            hudMistakes.innerText = `${mistakes}`;
        }

        function showStartScreen() {
            gameState = 'start';
            startScreen.classList.remove('hidden');
            pauseMenu.classList.add('hidden');
            resultScreen.classList.add('hidden');
            hudLayer.classList.add('hidden');
        }

        function togglePause() {
            if (gameState === 'playing') {
                gameState = 'paused';
                pauseMenu.classList.remove('hidden');
            } else if (gameState === 'paused') {
                gameState = 'playing';
                pauseMenu.classList.add('hidden');
                loop();
            }
        }

        // ================= æ¸¸æˆé€»è¾‘ =================

        function generateWaste(config) {
            let totalAngle = Math.PI * 2;
            let segmentAngle = totalAngle / config.wasteCount;
            totalWasteCount = 0;
            
            for(let i=0; i<config.wasteCount; i++) {
                let offset = Math.random() * 0.1;
                let start = i * segmentAngle + offset;
                let end = (i + 1) * segmentAngle - config.wasteGap + offset;
                
                if(end > start) {
                     wasteSegments.push({
                        start: start,
                        end: end,
                        active: true,
                        // åºŸæ–™é¢œè‰²æ”¹ä¸ºæ·±æ —è‰²ç³»
                        color: `hsl(${20 + Math.random()*5}, ${20+Math.random()*10}%, ${20 + Math.random()*10}%)`
                    });
                    totalWasteCount++;
                }
            }
            updateHUD();
        }

        function loop() {
            if (gameState !== 'playing') return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            let config = levels[currentLevelIndex];

            shakeOffset.x *= 0.8;
            shakeOffset.y *= 0.8;
            if(Math.abs(shakeOffset.x) < 0.5) shakeOffset.x = 0;
            if(Math.abs(shakeOffset.y) < 0.5) shakeOffset.y = 0;

            if (config.variableSpeed) {
                time += 0.05;
                currentSpeed = config.baseSpeed + Math.sin(time) * 0.01;
                if(currentSpeed < 0.005) currentSpeed = 0.005;
            } else {
                currentSpeed = config.baseSpeed;
            }

            rotationAngle += currentSpeed;
            
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.5;
                p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            }

            let remaining = wasteSegments.filter(s => s.active).length;
            if (remaining === 0) {
                if (gameState === 'playing') levelComplete();
            }
        }

        // ================= ç»“ç®—é€»è¾‘ =================

        function levelComplete() {
            gameState = 'level_complete';
            
            let stars = 0;
            let imgName = "emo-angry.png";
            let color = "#ffc107"; // é»˜è®¤æ˜Ÿè‰²(é»„è‰²)

            if (mistakes === 0) {
                stars = 3;
                imgName = "emo-satisfied.png";
            } else if (mistakes === 1) {
                stars = 2;
                imgName = "emo-good.png";
            } else {
                stars = 1;
                imgName = "emo-angry.png";
                color = "#c62828"; // å¤±è´¥æ—¶æ–‡å­—å˜çº¢ï¼Œä½†æ˜Ÿæ˜Ÿè¿˜æ˜¯é»„è‰²(é€šè¿‡ä¸‹é¢starRating.style.colorè¦†ç›–)
            }

            resultImg.src = `images/${imgName}`;
            // ç§»é™¤é»˜è®¤èƒŒæ™¯è‰²ï¼Œæ”¹ä¸ºé€æ˜ï¼Œä»¥é…åˆæ— è¾¹æ¡†è®¾è®¡
            resultImg.onerror = function() { this.style.opacity = '0.5'; }; 

            starRating.innerHTML = "â˜…".repeat(stars) + "<span style='opacity:0.2'>" + "â˜…".repeat(3-stars) + "</span>";
            starRating.style.color = "#ffc107"; // å¼ºåˆ¶æ˜Ÿæ˜Ÿä¸ºé»„è‰²
            
            resultTitle.innerText = "æŒ‘æˆ˜å®Œæˆ";
            resultTitle.style.color = mistakes > 1 ? "#c62828" : "#a67c00";
            
            resultDesc.innerHTML = `æŸä¼¤è®¡æ•°ï¼š${mistakes}<br><span style="font-size:16px; opacity:0.6; margin-top:10px; display:block">ä¸‹ä¸€å·¥åºå¾…è§£é”</span>`;
            
            // æŒ‰é’®é€»è¾‘ï¼šåŒæ—¶æ˜¾ç¤ºâ€œä¸‹ä¸€ç« â€(å¦‚æœæ¡ä»¶æ»¡è¶³) å’Œ â€œå†æ¥ä¸€æ¬¡â€
            
            // 1. ä¸‹ä¸€ç« æŒ‰é’®
            if (currentLevelIndex < levels.length - 1 && stars >= 1) {
                resultNextBtn.classList.remove('hidden');
                resultNextBtn.onclick = () => {
                    if(stamina >= 20) {
                        tryStartLevel(currentLevelIndex + 1);
                    } else {
                        alert("ä½“åŠ›ä¸è¶³ã€‚");
                        showStartScreen();
                    }
                };
                // å¦‚æœæœ‰ä¸‹ä¸€å…³ï¼Œâ€œå†æ¥ä¸€æ¬¡â€ä½œä¸ºæ¬¡è¦æŒ‰é’®
                resultRetryBtn.className = ""; 
            } else {
                resultNextBtn.classList.add('hidden');
                // å¦‚æœæ²¡æœ‰ä¸‹ä¸€å…³ï¼Œâ€œå†æ¥ä¸€æ¬¡â€ä½œä¸ºä¸»è¦æŒ‰é’®
                resultRetryBtn.className = "primary";
            }

            // 2. å†æ¥ä¸€æ¬¡æŒ‰é’®
            // å·²ç»åœ¨HTMLä¸­å®šä¹‰ï¼Œè¿™é‡Œç¡®ä¿æ˜¾ç¤ºå¹¶ç»‘å®šäº‹ä»¶
            resultRetryBtn.onclick = () => tryStartLevel(currentLevelIndex);

            setTimeout(() => {
                resultScreen.classList.remove('hidden');
                hudLayer.classList.add('hidden');
            }, 600);
        }

        function gameOver() {
            gameState = 'gameover';
            
            resultTitle.innerText = "åˆ¶èƒå¤±è´¥";
            resultTitle.style.color = "#c62828";
            
            resultImg.src = "images/emo-angry.png";
            starRating.innerHTML = "<span style='opacity:0.2'>â˜…â˜…â˜…</span>"; 
            starRating.style.color = "#ffc107";

            resultDesc.innerText = "èƒä½“å·²æŸæ¯ï¼Œæ— æ³•ç»§ç»­";
            
            // å¤±è´¥æ—¶éšè—ä¸‹ä¸€ç« 
            resultNextBtn.classList.add('hidden');
            
            // å†æ¥ä¸€æ¬¡ä½œä¸ºä¸»æŒ‰é’®
            resultRetryBtn.className = "primary";
            resultRetryBtn.onclick = () => tryStartLevel(currentLevelIndex);

            setTimeout(() => {
                resultScreen.classList.remove('hidden');
                hudLayer.classList.add('hidden');
            }, 300);
        }

        // ================= äº¤äº’ =================

        function handleInput(e) {
            e.preventDefault(); 
            if (gameState !== 'playing') return;
            triggerKnife();
        }

        function triggerKnife() {
            let knifeAngleInWoodSpace = (Math.PI / 2 - rotationAngle) % (Math.PI * 2);
            if (knifeAngleInWoodSpace < 0) knifeAngleInWoodSpace += Math.PI * 2;

            let hitWaste = false;

            for (let seg of wasteSegments) {
                if (seg.active) {
                    if (knifeAngleInWoodSpace >= seg.start && knifeAngleInWoodSpace <= seg.end) {
                        seg.active = false;
                        hitWaste = true;
                        eliminatedCount++;
                        updateHUD();
                        spawnParticles('#5d4037'); // åºŸæ–™ç¢å±‘é¢œè‰²
                        break;
                    }
                }
            }

            if (!hitWaste) {
                mistakes++;
                updateHUD();
                
                shakeOffset.x = (Math.random() - 0.5) * 20;
                shakeOffset.y = (Math.random() - 0.5) * 20;
                
                spawnParticles('#c62828'); 

                if (mistakes > maxMistakes) {
                    gameOver();
                }
            }
        }

        function spawnParticles(color) {
            for(let i=0; i<6; i++) {
                particles.push({
                    x: centerX,
                    y: centerY + woodRadius + wasteHeight,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 1) * 10,
                    life: 1.0,
                    r: Math.random() * Math.PI,
                    size: Math.random() * 4 + 1,
                    color: color
                });
            }
        }

        // ================= ç»˜å›¾ =================

        function draw() {
            // æ¸…ç©ºç”»å¸ƒ (é€æ˜)
            ctx.clearRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

            ctx.save();
            ctx.translate(centerX + shakeOffset.x, centerY + shakeOffset.y);
            ctx.rotate(rotationAngle);

            // 1. æ ¸å¿ƒèƒä½“ (åœ¨æµ…è‰²èƒŒæ™¯ä¸Šæ”¹ç”¨æ·±æª€æœ¨è‰²)
            ctx.beginPath();
            ctx.arc(0, 0, woodRadius, 0, Math.PI * 2);
            ctx.fillStyle = '#5d4037'; // æ·±æœ¨è‰²
            ctx.fill();
            
            // 2. æ—‹çº¹
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for(let i=10; i<woodRadius; i+=8) { 
                ctx.beginPath();
                ctx.arc(0, 0, i, 0, Math.PI * 2);
                ctx.stroke();
            }

            // 3. åºŸæ–™
            wasteSegments.forEach(seg => {
                if (seg.active) {
                    ctx.beginPath();
                    ctx.arc(0, 0, woodRadius + wasteHeight, seg.start, seg.end);
                    ctx.arc(0, 0, woodRadius, seg.end, seg.start, true);
                    ctx.fillStyle = seg.color; // CSSç”Ÿæˆçš„æ·±è‰²
                    ctx.fill();
                    // è¾¹ç¼˜
                    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                    ctx.stroke();
                }
            });

            ctx.restore();

            // 4. æ—‹åˆ€
            let drawX = centerX + shakeOffset.x;
            let drawY = centerY + shakeOffset.y;
            
            // åˆ€èº« (æ·±é“ç°è‰²)
            ctx.fillStyle = '#424242'; 
            ctx.beginPath();
            ctx.moveTo(drawX - 3, drawY + woodRadius + wasteHeight + 50);
            ctx.lineTo(drawX + 3, drawY + woodRadius + wasteHeight + 50);
            ctx.lineTo(drawX, drawY + woodRadius + wasteHeight + 5);
            ctx.fill();
            
            // åˆ€å°–
            ctx.fillStyle = '#d7ccc8';
            ctx.beginPath();
            ctx.arc(drawX, drawY + woodRadius + wasteHeight + 5, 2, 0, Math.PI*2);
            ctx.fill();

            // ç²’å­
            particles.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.r);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                ctx.restore();
            });
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput, {passive: false});

        initDimensions();
        showStartScreen(); 

    </script>
</body>
</html>